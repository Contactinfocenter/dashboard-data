<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agent Performance Analytics</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .chart-container { width: 100%; height: 100%; min-height: 240px; }
    .chip { @apply px-3 py-1 rounded-full text-sm cursor-pointer transition; }
    .chip.selected { @apply bg-blue-600 text-white font-semibold; }
    .chip.off { @apply bg-gray-200 text-gray-700; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#d9e4f5] to-[#f3f8ff] text-[#0f1724] p-6">

  <div class="max-w-[1600px] mx-auto">

    <!-- HEADER -->
    <div class="sticky top-0 z-50 flex flex-col md:flex-row items-center justify-between 
                bg-white/30 backdrop-blur-xl border border-white/40 shadow-lg rounded-2xl 
                p-5 mb-6">
      <div>
        <div class="text-2xl font-bold tracking-wide">Agent Performance</div>
        <div class="text-gray-600 text-sm">Date: <strong id="selectedDate">â€”</strong></div>
      </div>

      <div class="mt-4 md:mt-0 flex items-center gap-4">
        <span>ðŸ“…</span>
        <input id="datePicker" placeholder="Select date" class="bg-white/40 backdrop-blur-xl text-gray-700 text-sm rounded-lg border border-white/40 p-2.5">
        <button id="btnReload" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition">Reload</button>
      </div>
    </div>

    <!-- AGENT CHIPS -->
    <div class="mb-6 flex flex-wrap gap-2" id="agentChips">
      <p class="text-gray-500 text-sm">Loading agents...</p>
    </div>

    <!-- GRID: AHT + Login Summary -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

      <!-- AHT Heatmap -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-6 shadow">
        <h3 class="font-semibold mb-3">Average Handle Time (AHT) Heatmap</h3>
        <div class="chart-container h-96">
          <canvas id="ahtHeatmapChart"></canvas>
        </div>
      </div>

      <!-- Login Summary -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-6 shadow">
        <h3 class="font-semibold mb-3">Agent Login Summary</h3>
        <div class="chart-container h-96">
          <canvas id="loginSummaryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- GRID: Repeat Caller Rate + Leaderboard -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

      <!-- Repeat Caller Rate -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-6 shadow">
        <h3 class="font-semibold mb-3">Repeat Caller Rate per Agent</h3>
        <div class="chart-container h-96">
          <canvas id="repeatRateChart"></canvas>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-6 shadow">
        <h3 class="font-semibold mb-3">Agent Leaderboard (Top Agents)</h3>
        <div class="overflow-auto max-h-96">
          <table class="min-w-full text-sm text-left">
            <thead>
              <tr class="bg-blue-600 text-white">
                <th class="px-4 py-2">Agent</th>
                <th class="px-4 py-2">Total Calls</th>
                <th class="px-4 py-2">Unique Calls</th>
                <th class="px-4 py-2">Avg Handle Time</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody">
              <tr><td colspan="4" class="text-center py-4 text-gray-500">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAb1x31pma-pubWkJHHFjeGA_t2w4cLKY8",
      authDomain: "dashboard-24856.firebaseapp.com",
      databaseURL: "https://dashboard-24856-default-rtdb.firebaseio.com",
      projectId: "dashboard-24856",
      storageBucket: "dashboard-24856.appspot.com",
      messagingSenderId: "484671281554",
      appId: "1:484671281554:web:218b6fa714f61aa158894b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const callsRef = ref(db, 'calls');

    const agentChipsContainer = document.getElementById('agentChips');
    const datePicker = document.getElementById('datePicker');
    const selectedDateLabel = document.getElementById('selectedDate');
    const leaderboardBody = document.getElementById('leaderboardBody');

    let selectedAgent = null;
    let allAgents = [];
    let heatmapChart, loginChart, repeatChart;

    function buildAgentChips(agents) {
      agentChipsContainer.innerHTML = '';
      agents.forEach(agent => {
        const chip = document.createElement('div');
        chip.className = 'chip off';
        chip.textContent = agent;
        chip.addEventListener('click', () => {
          selectedAgent = agent;
          updateChipSelection();
          renderAllCharts();
        });
        agentChipsContainer.appendChild(chip);
      });
    }

    function updateChipSelection() {
      Array.from(agentChipsContainer.children).forEach(chip => {
        chip.classList.toggle('selected', chip.textContent === selectedAgent);
        chip.classList.toggle('off', chip.textContent !== selectedAgent);
      });
    }

    function processDataForDate(rawData, date) {
      const agentsData = {};
      if (!rawData[date]) return agentsData;

      Object.values(rawData[date]).forEach(call => {
        const name = call.full_name || 'Unknown';
        if (!agentsData[name]) agentsData[name] = { aht: Array(24).fill(0), total:0, unique: new Set() };
        const hour = new Date(call.call_date).getHours();
        agentsData[name].aht[hour] += call.acht || 0;
        agentsData[name].total += 1;
        agentsData[name].unique.add(call.phone_number);
      });

      return agentsData;
    }

    function renderAHTHeatmap(agentsData) {
      const labels = Array.from({length: 24}, (_, i) => i + ':00');
      const datasets = [];

      Object.entries(agentsData).forEach(([agent, data]) => {
        if (selectedAgent && agent !== selectedAgent) return;
        datasets.push({
          label: agent,
          data: data.aht,
          backgroundColor: data.aht.map(v => {
            if (v === 0) return '#e2e8f0';
            if (v < 200) return '#34d399';
            if (v < 400) return '#facc15';
            return '#f87171';
          }),
          borderWidth: 1
        });
      });

      if (heatmapChart) heatmapChart.destroy();
      const ctx = document.getElementById('ahtHeatmapChart').getContext('2d');
      heatmapChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: { responsive:true, plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                   scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display:true, text:'AHT (s)' } } } },
        plugins: [ChartDataLabels]
      });
    }

    function renderLoginSummary(agentsData) {
      const labels = Object.keys(agentsData).filter(agent => !selectedAgent || agent === selectedAgent);
      const logins = labels.map(agent => agentsData[agent].total);

      if (loginChart) loginChart.destroy();
      const ctx = document.getElementById('loginSummaryChart').getContext('2d');
      loginChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label:'Calls', data: logins, backgroundColor:'#3b82f6' }] },
        options: { responsive:true, plugins:{ legend:{ display:false }, datalabels:{ display:true } } }
      });
    }

    function renderRepeatRate(agentsData) {
      const labels = Object.keys(agentsData).filter(agent => !selectedAgent || agent === selectedAgent);
      const repeatRates = labels.map(agent => {
        const total = agentsData[agent].total;
        const unique = agentsData[agent].unique.size;
        return total > 0 ? ((total - unique)/total*100).toFixed(1) : 0;
      });

      if (repeatChart) repeatChart.destroy();
      const ctx = document.getElementById('repeatRateChart').getContext('2d');
      repeatChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label:'Repeat Rate %', data: repeatRates, backgroundColor:'#fbbf24' }] },
        options: { responsive:true, plugins:{ legend:{ display:false }, datalabels:{ display:true, formatter: (val)=>val+'%' } },
                   scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }

    function renderLeaderboard(agentsData) {
      const rows = Object.entries(agentsData).map(([agent, data]) => {
        return { agent, total: data.total, unique: data.unique.size, aht: (data.aht.reduce((a,b)=>a+b,0)/24).toFixed(1) };
      }).sort((a,b)=>b.total - a.total);

      leaderboardBody.innerHTML = '';
      if (!rows.length) {
        leaderboardBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No data</td></tr>`;
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-4 py-2">${r.agent}</td>
                        <td class="px-4 py-2">${r.total}</td>
                        <td class="px-4 py-2">${r.unique}</td>
                        <td class="px-4 py-2">${r.aht}s</td>`;
        leaderboardBody.appendChild(tr);
      });
    }

    function renderAllCharts() {
      const date = datePicker.value || selectedDateLabel.textContent;
      const agentsData = processDataForDate(window.rawData, date);
      renderAHTHeatmap(agentsData);
      renderLoginSummary(agentsData);
      renderRepeatRate(agentsData);
      renderLeaderboard(agentsData);
    }

    onValue(callsRef, snapshot => {
      window.rawData = snapshot.val() || {};

      const agentsSet = new Set();
      Object.values(window.rawData).forEach(day => {
        Object.values(day).forEach(call => { if(call.full_name) agentsSet.add(call.full_name); });
      });
      allAgents = Array.from(agentsSet).sort();
      buildAgentChips(allAgents);

      const dates = Object.keys(window.rawData).sort().reverse();
      const defaultDate = dates[0] || '';
      datePicker.value = defaultDate;
      selectedDateLabel.textContent = defaultDate;

      renderAllCharts();
    });

    flatpickr(datePicker, {
      dateFormat: 'Y-m-d',
      onChange: (selectedDates, dateStr) => {
        selectedDateLabel.textContent = dateStr;
        renderAllCharts();
      }
    });

    document.getElementById('btnReload').addEventListener('click', renderAllCharts);
  </script>
</body>
</html>
