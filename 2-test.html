<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Performance â€” Carnival Call Analytics</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flowbite -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .chart-container { width: 100%; height: 100%; min-height: 220px; }
    /* small tweak so sticky tab header over canvas doesn't hide content */
    thead.sticky { position: sticky; top: 0; z-index: 20; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#d9e4f5] to-[#f3f8ff] text-[#0f1724] p-6">
  <div class="max-w-[1600px] mx-auto">

    <!-- MAIN HEADER (keeps your theme) -->
    <header class="sticky top-0 z-50 flex flex-col md:flex-row items-center justify-between
                   bg-white/30 backdrop-blur-xl border border-white/40 shadow-lg rounded-2xl p-5 mb-6">
      <div>
        <div class="text-2xl font-bold tracking-wide">Agent Performance Analytics</div>
        <div class="text-gray-600 text-sm">Data of: <strong id="selectedDate">â€”</strong></div>
      </div>

      <div class="mt-4 md:mt-0 flex items-center gap-4">
        <div class="flex items-center">
          <span class="mr-2">ðŸ“…</span>
          <input id="datePicker" placeholder="Select date"
                 class="bg-white/40 backdrop-blur-xl text-gray-700 text-sm rounded-lg border border-white/40 p-2.5" />
        </div>

        <button id="btnReload" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md">
          Reload
        </button>
      </div>
    </header>

    <!-- KPI ROW -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
        <div class="text-gray-600 text-sm">Total Calls</div>
        <div class="text-2xl font-bold" id="kpiTotalCalls">0</div>
      </div>
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
        <div class="text-gray-600 text-sm">Active Agents</div>
        <div class="text-2xl font-bold" id="kpiActiveAgents">0</div>
      </div>
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
        <div class="text-gray-600 text-sm">Top Performer</div>
        <div class="text-2xl font-bold" id="kpiTopAgent">â€”</div>
      </div>
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
        <div class="text-gray-600 text-sm">Avg Handle Time</div>
        <div class="text-2xl font-bold" id="kpiAvgAHT">0s</div>
      </div>
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
        <div class="text-gray-600 text-sm">Avg Repeat %</div>
        <div class="text-2xl font-bold" id="kpiRepeatPct">0%</div>
      </div>
    </div>

    <!-- Keep your original charts grid (first half of page) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Average Hourly Chart (left) -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
        <h3 class="font-semibold mb-3">Average Hourly Call Volume (All Time)</h3>
        <div class="chart-container h-72"><canvas id="avgHourlyChart"></canvas></div>
      </div>

      <!-- Hourly Call Volume (selected) -->
      <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
        <h3 class="font-semibold mb-3">Hourly Call Volume (Selected Date)</h3>
        <div class="chart-container h-72"><canvas id="lastDayHourlyChart"></canvas></div>
      </div>
    </div>

    <!-- NEW: Tabs for Agent Analysis (Option A) -->
    <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
      <!-- Tabs control -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex gap-2">
          <button class="tab-btn px-4 py-2 rounded-lg text-[#004c99] font-semibold border-b-2 border-[#004c99]" data-tab="aht">AHT Heatmap</button>
          <button class="tab-btn px-4 py-2 rounded-lg text-gray-600" data-tab="login">Login Summary</button>
          <button class="tab-btn px-4 py-2 rounded-lg text-gray-600" data-tab="repeat">Repeat Caller Rate</button>
          <button class="tab-btn px-4 py-2 rounded-lg text-gray-600" data-tab="leader">Agent Leaderboard</button>
          <button class="tab-btn px-4 py-2 rounded-lg text-gray-600" data-tab="summary">Call Summary Table</button>
        </div>

        <div class="text-sm text-gray-600">Agent filters:</div>
      </div>

      <!-- TABS CONTENT -->
      <div id="tabsContent">
        <!-- AHT Heatmap Tab -->
        <div class="tab-panel" data-panel="aht">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <div class="lg:col-span-1">
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
                <h4 class="font-semibold text-[#004c99] mb-3">Agents</h4>
                <div id="agentChipContainer" class="flex flex-col gap-2 max-h-[420px] overflow-y-auto p-1"></div>
              </div>
            </div>

            <div class="lg:col-span-3">
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
                <h4 class="font-semibold mb-3">AHT Heatmap (Avg ACHT per hour)</h4>
                <div class="chart-container h-96"><canvas id="ahtHeatmapCanvas"></canvas></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Login Summary Tab -->
        <div class="tab-panel hidden" data-panel="login">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
                <h4 class="font-semibold mb-3">Login Summary (first/last call per day)</h4>
                <div id="loginSummaryContainer" class="overflow-auto max-h-[520px]"></div>
              </div>
            </div>
            <div>
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
                <h4 class="font-semibold text-[#004c99] mb-3">Quick Info</h4>
                <p class="text-sm text-gray-600">Login times are inferred from calls (first call = login, last call = logout).</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Repeat Caller Rate Tab -->
        <div class="tab-panel hidden" data-panel="repeat">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
                <h4 class="font-semibold mb-3">Repeat Caller Rate per Agent</h4>
                <div class="chart-container h-96"><canvas id="repeatRateChart"></canvas></div>
              </div>
            </div>
            <div>
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
                <h4 class="font-semibold text-[#004c99] mb-3">Method</h4>
                <p class="text-sm text-gray-600">Repeat rate = (# callers with >1 calls handled by the agent) / (unique callers of agent)</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Leaderboard Tab -->
        <div class="tab-panel hidden" data-panel="leader">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
                <h4 class="font-semibold mb-3">Agent Leaderboard</h4>
                <div id="leaderboardContainer" class="space-y-3 max-h-[520px] overflow-y-auto p-1"></div>
              </div>
            </div>
            <div>
              <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-xl p-4 shadow">
                <h4 class="font-semibold text-[#004c99] mb-3">Wallboard</h4>
                <p class="text-sm text-gray-600">Leaderboard shows top agents by total calls. Use as a quick wallboard view.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Call Summary Table Tab -->
        <div class="tab-panel hidden" data-panel="summary">
          <div class="bg-white/40 backdrop-blur-xl border border-white/40 rounded-2xl p-4 shadow">
            <h4 class="font-semibold mb-3">Call Summary Table (per agent)</h4>
            <div id="callSummaryTable" class="overflow-auto max-h-[520px]"></div>
          </div>
        </div>
      </div>
    </div> <!-- end tabs container -->

    <!-- Footer -->
    <footer class="text-center text-sm text-gray-500 pt-6">
      Carnival Call Analytics â€¢ Â© 2025
    </footer>
  </div>

  <!-- Flowbite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>

 Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
Â  Â  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

Â  Â  // --------- FIREBASE CONFIG (from you) ----------
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAb1x31pma-pubWkJHHFjeGA_t2w4cLKY8",
Â  Â  Â  authDomain: "dashboard-24856.firebaseapp.com",
Â  Â  Â  databaseURL: "https://dashboard-24856-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "dashboard-24856",
Â  Â  Â  storageBucket: "dashboard-24856.appspot.com",
Â  Â  Â  messagingSenderId: "484671281554",
Â  Â  Â  appId: "1:484671281554:web:218b6fa714f61aa158894b"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getDatabase(app);
Â  Â  const callsRef = ref(db, 'calls');

Â  Â  // Chart instances
Â  Â  let avgHourlyChart = null; // NEW
Â  Â  let lastDayHourlyChart = null; // NEW
Â  Â  let ahtHeatmapChart = null;
Â  Â  let repeatRateChart = null;

Â  Â  // App state
Â  Â  let rawData = {}; Â // full firebase snapshot
Â  Â  let agentList = []; // sorted agents
Â  Â  let agentStats = {}; // aggregated per-agent stats
    let selectedDate = new Date().toISOString().slice(0, 10); // NEW: Default selected date (today)

Â  Â  // Utilities
Â  Â  function safeNum(v){ return Number.isFinite(Number(v)) ? Number(v) : 0; }
    
    // Function to update the selected date display
    function updateSelectedDateDisplay(dateStr) {
        document.getElementById('selectedDate').textContent = dateStr;
    }

    // Function to get call data for a specific date
    function getCallsForDate(dateStr) {
        return rawData[dateStr] || {};
    }

Â  Â  // ---------- DATA PROCESSING ----------
Â  Â  function processRawData(data) {
Â  Â  Â  rawData = data || {};
Â  Â  Â  agentStats = {};

Â  Â  Â  // iterate date -> callId -> call
Â  Â  Â  for (const dateKey in rawData) {
Â  Â  Â  Â  const calls = rawData[dateKey] || {};
Â  Â  Â  Â  for (const callId in calls) {
Â  Â  Â  Â  Â  const call = calls[callId];
Â  Â  Â  Â  Â  if (!call) continue;
Â  Â  Â  Â  Â  const agent = (call.full_name || "Unknown").trim();
Â  Â  Â  Â  Â  const phone = call.phone_number || null;
Â  Â  Â  Â  Â  const status = call.status || "";
Â  Â  Â  Â  Â  const acht = safeNum(call.acht);
Â  Â  Â  Â  Â  const callDate = call.call_date ? new Date(call.call_date) : null;

Â  Â  Â  Â  Â  if (!agentStats[agent]) {
Â  Â  Â  Â  Â  Â  agentStats[agent] = {
Â  Â  Â  Â  Â  Â  Â  total: 0,
Â  Â  Â  Â  Â  Â  Â  fcr: 0,
Â  Â  Â  Â  Â  Â  Â  nonFcr: 0,
Â  Â  Â  Â  Â  Â  Â  ahtSum: 0,
Â  Â  Â  Â  Â  Â  Â  uniqueCallers: new Set(),
Â  Â  Â  Â  Â  Â  Â  callerCounts: {}, // phone -> count handled by agent
Â  Â  Â  Â  Â  Â  Â  hourly: Array.from({length:24},()=>[]),
Â  Â  Â  Â  Â  Â  Â  firstPerDay: {}, // dateStr -> first Date
Â  Â  Â  Â  Â  Â  Â  lastPerDay: {}, Â // dateStr -> last Date
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  Â  Â  s.total++;
Â  Â  Â  Â  Â  s.ahtSum += acht;
Â  Â  Â  Â  Â  if (status === "FCR") s.fcr++; else s.nonFcr++;

Â  Â  Â  Â  Â  if (phone) {
Â  Â  Â  Â  Â  Â  s.uniqueCallers.add(phone);
Â  Â  Â  Â  Â  Â  s.callerCounts[phone] = (s.callerCounts[phone] || 0) + 1;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (callDate) {
Â  Â  Â  Â  Â  Â  const hr = callDate.getHours();
Â  Â  Â  Â  Â  Â  s.hourly[hr].push(acht);

Â  Â  Â  Â  Â  Â  const dStr = callDate.toISOString().slice(0,10);
Â  Â  Â  Â  Â  Â  if (!s.firstPerDay[dStr] || callDate < s.firstPerDay[dStr]) s.firstPerDay[dStr] = callDate;
Â  Â  Â  Â  Â  Â  if (!s.lastPerDay[dStr] || callDate > s.lastPerDay[dStr]) s.lastPerDay[dStr] = callDate;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // finalize agent list
Â  Â  Â  agentList = Object.keys(agentStats).sort((a,b)=> a.localeCompare(b));
Â  Â  Â  renderKPIs();
Â  Â  Â  renderAgentChips();
Â  Â  Â  renderAllChartsAndTables();
Â  Â  }

Â  Â  // ---------- RENDER KPIs ----------
Â  Â  function renderKPIs() {
Â  Â  Â  const totalCalls = Object.values(agentStats).reduce((s,a)=> s + (a.total||0), 0);
Â  Â  Â  const activeAgents = Object.keys(agentStats).length;

Â  Â  Â  // compute avg aht across agents (weighted)
Â  Â  Â  const grandAhtSum = Object.values(agentStats).reduce((s,a)=> s + (a.ahtSum||0),0);
Â  Â  Â  const grandCallCount = totalCalls || 1;
Â  Â  Â  const avgAht = Math.round(grandAhtSum / grandCallCount);

Â  Â  Â  // repeat pct: overall
Â  Â  Â  let repeatCount = 0, uniqueCount = 0;
Â  Â  Â  for (const agent of Object.keys(agentStats)) {
Â  Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  Â  const repeats = Object.values(s.callerCounts).filter(c=>c>1).length;
Â  Â  Â  Â  repeatCount += repeats;
Â  Â  Â  Â  uniqueCount += s.uniqueCallers.size;
Â  Â  Â  }
Â  Â  Â  const repeatPct = uniqueCount ? Math.round((repeatCount / uniqueCount) * 100) : 0;

Â  Â  Â  // top performer by total calls
Â  Â  Â  const topAgent = Object.entries(agentStats).sort((a,b)=> b[1].total - a[1].total)[0]?.[0] || 'â€”';

Â  Â  Â  document.getElementById('kpiTotalCalls').textContent = totalCalls;
Â  Â  Â  document.getElementById('kpiActiveAgents').textContent = activeAgents;
Â  Â  Â  document.getElementById('kpiTopAgent').textContent = topAgent;
Â  Â  Â  document.getElementById('kpiAvgAHT').textContent = avgAht + 's';
Â  Â  Â  document.getElementById('kpiRepeatPct').textContent = repeatPct + '%';
Â  Â  }
    
    // ---------- CHARTS: HOURLY VOLUMES (NEW LOGIC) ----------
    // Computes hourly call volume across all dates (for the "All Time" chart)
    function computeAvgHourlyVolume() {
        const hourlyCounts = Array.from({length: 24}, () => 0);
        let totalDays = 0;

        for (const dateKey in rawData) {
            const calls = rawData[dateKey] || {};
            const dailyHourlyCounts = Array.from({length: 24}, () => 0);
            let hasCalls = false;

            for (const callId in calls) {
                const call = calls[callId];
                const callDate = call.call_date ? new Date(call.call_date) : null;
                if (callDate) {
                    const hr = callDate.getHours();
                    dailyHourlyCounts[hr]++;
                    hasCalls = true;
                }
            }
            
            if (hasCalls) {
                totalDays++;
                dailyHourlyCounts.forEach((count, hr) => {
                    hourlyCounts[hr] += count;
                });
            }
        }

        const avgHourly = hourlyCounts.map(count => totalDays ? Math.round(count / totalDays) : 0);
        return avgHourly;
    }

    // Computes hourly call volume for the selected date
    function computeSelectedDateHourlyVolume(dateStr) {
        const calls = getCallsForDate(dateStr);
        const hourlyCounts = Array.from({length: 24}, () => 0);

        for (const callId in calls) {
            const call = calls[callId];
            const callDate = call.call_date ? new Date(call.call_date) : null;
            if (callDate) {
                const hr = callDate.getHours();
                hourlyCounts[hr]++;
            }
        }
        return hourlyCounts;
    }

    // Render the "Average Hourly Call Volume (All Time)" chart
    function renderAvgHourlyChart(avgData) {
        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        const ctx = document.getElementById('avgHourlyChart').getContext('2d');
        if (avgHourlyChart) avgHourlyChart.destroy();

        avgHourlyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Avg Calls',
                    data: avgData,
                    borderColor: '#004c99',
                    backgroundColor: 'rgba(0, 76, 153, 0.1)',
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#004c99' } },
                    y: { beginAtZero: true, title: { display: true, text: 'Avg Calls' }, ticks: { color:'#004c99' } }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Render the "Hourly Call Volume (Selected Date)" chart
    function renderLastDayHourlyChart(hourlyData, dateStr) {
        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        const ctx = document.getElementById('lastDayHourlyChart').getContext('2d');
        if (lastDayHourlyChart) lastDayHourlyChart.destroy();

        lastDayHourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: `Calls on ${dateStr}`,
                    data: hourlyData,
                    backgroundColor: '#f39c12',
                    borderRadius: 4
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#004c99' } },
                    y: { beginAtZero: true, title: { display: true, text: 'Total Calls' }, ticks: { color:'#004c99' } }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }


Â  Â  // ---------- AGENT CHIPS (single-select) ----------
Â  Â  function renderAgentChips() {
Â  Â  Â  const container = document.getElementById('agentChipContainer');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  agentList.forEach(agent => {
Â  Â  Â  Â  const el = document.createElement('button');
Â  Â  Â  Â  el.type = 'button';
Â  Â  Â  Â  el.className = 'text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full min-w-[70px] text-center transition';
Â  Â  Â  Â  el.textContent = agent;
Â  Â  Â  Â  el.onclick = () => {
Â  Â  Â  Â  Â  // remove selected classes
Â  Â  Â  Â  Â  container.querySelectorAll('button').forEach(b=>{
Â  Â  Â  Â  Â  Â  b.classList.remove('bg-[#f39c12]','text-white','font-semibold','shadow-md');
Â  Â  Â  Â  Â  Â  b.classList.add('text-gray-700','bg-gray-100');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // style this
Â  Â  Â  Â  Â  el.classList.add('bg-[#f39c12]','text-white','font-semibold','shadow-md');
Â  Â  Â  Â  Â  el.classList.remove('text-gray-700','bg-gray-100');
Â  Â  Â  Â  Â  // render heatmap for selected agent
Â  Â  Â  Â  Â  renderAHTHeatmap(agent);
Â  Â  Â  Â  };
Â  Â  Â  Â  container.appendChild(el);
Â  Â  Â  });

Â  Â  Â  // auto-select first agent if exists
Â  Â  Â  if (agentList.length) {
Â  Â  Â  Â  const firstBtn = container.querySelector('button');
Â  Â  Â  Â  if (firstBtn) firstBtn.click();
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------- AHT HEATMAP ----------
Â  Â  function computeAhtPerHour(agent) {
Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  if (!s) return Array.from({length:24},()=>0);
Â  Â  Â  return s.hourly.map(arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0);
Â  Â  }

Â  Â  function renderAHTHeatmap(agent) {
Â  Â  Â  const data = computeAhtPerHour(agent);
Â  Â  Â  const labels = Array.from({length:24},(_,i)=> `${i}:00`);

Â  Â  Â  const ctx = document.getElementById('ahtHeatmapCanvas').getContext('2d');
Â  Â  Â  if (ahtHeatmapChart) ahtHeatmapChart.destroy();

Â  Â  Â  ahtHeatmapChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels,
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  label: `Avg ACHT (s) â€” ${agent}`,
Â  Â  Â  Â  Â  Â  data,
Â  Â  Â  Â  Â  Â  backgroundColor: data.map(v => v === 0 ? '#e2e8f0' : (v > 400 ? '#f39c12' : '#60a5fa')),
Â  Â  Â  Â  Â  Â  borderRadius: 4
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  plugins: { legend: { display: false } },
Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  x: { ticks: { color: '#004c99' } },
Â  Â  Â  Â  Â  Â  y: { beginAtZero: true, ticks: { color:'#004c99' } }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  maintainAspectRatio: false
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------- LOGIN SUMMARY ----------
Â  Â  function renderLoginSummary() {
Â  Â  Â  const container = document.getElementById('loginSummaryContainer');
Â  Â  Â  const rows = [];

Â  Â  Â  for (const agent of agentList) {
Â  Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  Â  // compute per-day active hours array
Â  Â  Â  Â  const perDay = [];
Â  Â  Â  Â  for (const dStr in s.firstPerDay) {
Â  Â  Â  Â  Â  const first = s.firstPerDay[dStr];
Â  Â  Â  Â  Â  const last = s.lastPerDay[dStr] || first;
Â  Â  Â  Â  Â  const hours = Math.max(0, (last - first) / 3600000); // in hours
Â  Â  Â  Â  Â  perDay.push({ date: dStr, first: first.toLocaleTimeString(), last: last.toLocaleTimeString(), hours: Number(hours.toFixed(2)) });
Â  Â  Â  Â  }
Â  Â  Â  Â  // aggregate
Â  Â  Â  Â  const totalDays = perDay.length;
Â  Â  Â  Â  const avgDaily = totalDays ? (perDay.reduce((a,b)=>a+b.hours,0) / totalDays).toFixed(2) : '0.00';
Â  Â  Â  Â  const totalHours = perDay.reduce((a,b)=>a+b.hours,0).toFixed(2);

Â  Â  Â  Â  rows.push({ agent, totalDays, totalHours, avgDaily, perDay });
Â  Â  Â  }

Â  Â  Â  // render simple table
Â  Â  Â  let html = '<table class="min-w-full text-sm"><thead class="bg-gray-100 sticky"><tr>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-left">Agent</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Active Days</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Total Hours</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Avg Hours/Day</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '</tr></thead><tbody>';
Â  Â  Â  for (const r of rows) {
Â  Â  Â  Â  html += `<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-semibold">${r.agent}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${r.totalDays}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${r.totalHours}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${r.avgDaily}</td></tr>`;
Â  Â  Â  }
Â  Â  Â  html += '</tbody></table>';
Â  Â  Â  container.innerHTML = html;
Â  Â  }

Â  Â  // ---------- REPEAT CALLER RATE ----------
Â  Â  function renderRepeatRateChart() {
Â  Â  Â  const labels = [];
Â  Â  Â  const data = [];

Â  Â  Â  for (const agent of agentList) {
Â  Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  Â  const unique = s.uniqueCallers.size || 0;
Â  Â  Â  Â  const repeats = Object.values(s.callerCounts).filter(c=>c>1).length;
Â  Â  Â  Â  const pct = unique ? Math.round((repeats / unique) * 100) : 0;
Â  Â  Â  Â  labels.push(agent);
Â  Â  Â  Â  data.push(pct);
Â  Â  Â  }

Â  Â  Â  const ctx = document.getElementById('repeatRateChart').getContext('2d');
Â  Â  Â  if (repeatRateChart) repeatRateChart.destroy();

Â  Â  Â  repeatRateChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: { labels, datasets: [{ label:'Repeat %', data, backgroundColor: labels.map(()=> '#60a5fa') }] },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  plugins: { legend: { display: false } },
Â  Â  Â  Â  Â  scales: { x: { ticks: { color: '#004c99' }}, y: { beginAtZero: true, ticks: { color:'#004c99' } } },
Â  Â  Â  Â  Â  maintainAspectRatio: false
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------- LEADERBOARD ----------
Â  Â  function renderLeaderboard() {
Â  Â  Â  const container = document.getElementById('leaderboardContainer');
Â  Â  Â  // rank by total calls, show top 20
Â  Â  Â  const ranked = Object.entries(agentStats).map(([agent,s])=> ({ agent, total: s.total, fcr: s.fcr, avgAht: s.total?Math.round(s.ahtSum/s.total):0 })) 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a,b)=> b.total - a.total)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .slice(0, 50);
Â  Â  Â  let html = '';
Â  Â  Â  ranked.forEach((r, idx) => {
Â  Â  Â  Â  html += `<div class="flex items-center justify-between p-3 rounded-lg ${idx < 3 ? 'bg-[#fef3c7]' : 'bg-white/60'} shadow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-10 h-10 flex items-center justify-center rounded-full bg-[#004c99] text-white font-bold">${idx+1}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-semibold">${r.agent}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-600">Calls: ${r.total} â€¢ FCR: ${r.fcr} â€¢ AHT: ${r.avgAht}s</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-lg font-bold">${r.total}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500">calls</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  });
Â  Â  Â  container.innerHTML = html;
Â  Â  }

Â  Â  // ---------- CALL SUMMARY TABLE ----------
Â  Â  function renderCallSummaryTable() {
Â  Â  Â  const container = document.getElementById('callSummaryTable');
Â  Â  Â  let html = '<table class="min-w-full text-sm"><thead class="bg-gray-100 sticky"><tr>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-left">Agent</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Total Calls</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Unique Callers</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">FCR</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '<th class="px-3 py-2 text-center">Avg AHT</th>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â '</tr></thead><tbody>';
Â  Â  Â  for (const agent of agentList) {
Â  Â  Â  Â  const s = agentStats[agent];
Â  Â  Â  Â  const avgAht = s.total ? Math.round(s.ahtSum / s.total) : 0;
Â  Â  Â  Â  html += `<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-semibold">${agent}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${s.total}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${s.uniqueCallers.size}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${s.fcr}</td>` +
Â  Â  Â  Â  Â  Â  Â  Â  `<td class="px-3 py-2 text-center">${avgAht}s</td></tr>`;
Â  Â  Â  }
Â  Â  Â  html += '</tbody></table>';
Â  Â  Â  container.innerHTML = html;
Â  Â  }

Â  Â  // ---------- RENDER ALL (UPDATED LOGIC) ----------
Â  Â  function renderAllChartsAndTables() {
        // Determine the most recent date from the loaded data for the 'Selected Date' chart
        const allDates = Object.keys(rawData).sort().reverse();
        // Use the stored selectedDate or the most recent available date
        const dateToDisplay = allDates.includes(selectedDate) ? selectedDate : allDates[0] || new Date().toISOString().slice(0, 10);

        // Update the global state and display
        selectedDate = dateToDisplay;
        updateSelectedDateDisplay(selectedDate);
        
        // RENDER MAIN CHARTS
        const avgData = computeAvgHourlyVolume();
        renderAvgHourlyChart(avgData);

        const hourlyData = computeSelectedDateHourlyVolume(selectedDate);
        renderLastDayHourlyChart(hourlyData, selectedDate);
        
        // RENDER TABULAR/OTHER DATA
Â  Â  Â  Â  renderLoginSummary();
Â  Â  Â  Â  renderRepeatRateChart();
Â  Â  Â  Â  renderLeaderboard();
Â  Â  Â  Â  renderCallSummaryTable();
Â  Â  Â  Â  
Â  Â  Â  Â  // Ensure the initial AHT heatmap renders for the first agent
Â  Â  Â  Â  const firstAgent = agentList[0];
Â  Â  Â  Â  if (firstAgent && document.querySelector('.tab-btn[data-tab="aht"]').classList.contains('border-[#004c99]')) {
Â  Â  Â  Â  Â  Â  renderAHTHeatmap(firstAgent);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ---------- TABS behavior ----------
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  const btn = e.target.closest('.tab-btn');
Â  Â  Â  if (!btn) return;
Â  Â  Â  const tab = btn.dataset.tab;
Â  Â  Â  // style active
Â  Â  Â  document.querySelectorAll('.tab-btn').forEach(b=>{
Â  Â  Â  Â  b.classList.remove('text-[#004c99]','font-semibold','border-b-2','border-[#004c99]');
Â  Â  Â  Â  b.classList.add('text-gray-600');
Â  Â  Â  });
Â  Â  Â  btn.classList.add('text-[#004c99]','font-semibold','border-b-2','border-[#004c99]');
Â  Â  Â  // switch panels
Â  Â  Â  document.querySelectorAll('.tab-panel').forEach(p=>{
Â  Â  Â  Â  p.classList.add('hidden');
Â  Â  Â  });
Â  Â  Â  const panel = document.querySelector(`.tab-panel[data-panel="${tab}"]`);
Â  Â  Â  if (panel) panel.classList.remove('hidden');
Â  Â  Â  // if switching to certain tabs, re-render some charts to ensure proper sizing
Â  Â  Â  if (tab === 'repeat') { if (repeatRateChart) repeatRateChart.resize(); }
Â  Â  Â  if (tab === 'aht') { if (ahtHeatmapChart) ahtHeatmapChart.resize(); }
Â  Â  });

Â  Â  // default tab set
Â  Â  setTimeout(()=> {
Â  Â  Â  const defaultBtn = document.querySelector('.tab-btn[data-tab="aht"]');
Â  Â  Â  if (defaultBtn) defaultBtn.click();
Â  Â  }, 50);

Â  Â  // ---------- FIREBASE: load data ----------
Â  Â  onValue(callsRef, (snap) => {
Â  Â  Â  const data = snap.val() || {};
Â  Â  Â  processRawData(data);
Â  Â  });

Â  Â  // Reload button
Â  Â  document.getElementById('btnReload').addEventListener('click', ()=>{
Â  Â  Â  // force refresh by re-processing rawData
Â  Â  Â  processRawData(rawData);
Â  Â  });

Â  Â  // basic datePicker (flatpickr optional if you load it)
Â  Â  try {
Â  Â  Â  const fp = flatpickr('#datePicker', { mode:'single', altInput:true, altFormat:'F j, Y', dateFormat:'Y-m-d' });
Â  Â  Â  fp.config.onChange.push((selectedDates, dateStr)=> {
        // Update state and re-render the two main hourly charts
        if (dateStr) {
          selectedDate = dateStr; // Update the global selected date
          updateSelectedDateDisplay(selectedDate);

          // Re-render the Hourly Volume (Selected Date) chart with the new filter
          const hourlyData = computeSelectedDateHourlyVolume(selectedDate);
          renderLastDayHourlyChart(hourlyData, selectedDate);
        }
Â  Â  Â  });
Â  Â  } catch(e){ /* flatpickr not loaded â€” safe to ignore */ }

Â  Â  // initial: empty render
Â  Â  renderKPIs();
Â  Â  renderAllChartsAndTables();

Â  </script>
</body>
</html>
